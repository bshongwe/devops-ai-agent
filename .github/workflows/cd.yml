name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'success' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')) &&
      secrets.KUBECONFIG_STAGING != ''
    environment:
      name: staging
      url: https://staging-ci-cd-agent.example.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
        
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > ~/.kube/config
        
    - name: Deploy to staging
      run: |
        kubectl set image deployment/ci-cd-agent \
          ci-cd-agent=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -n staging
        kubectl rollout status deployment/ci-cd-agent -n staging
        
    - name: Run health checks
      run: |
        kubectl wait --for=condition=ready pod -l app=ci-cd-agent -n staging --timeout=300s
        curl -f https://staging-ci-cd-agent.example.com/webhooks/health
        
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.environment == 'production' &&
      secrets.KUBECONFIG_PRODUCTION != ''
    environment:
      name: production
      url: https://ci-cd-agent.example.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
        
    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
        
    - name: Deploy to production
      run: |
        kubectl set image deployment/ci-cd-agent \
          ci-cd-agent=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -n production
        kubectl rollout status deployment/ci-cd-agent -n production
        
    - name: Run health checks
      run: |
        kubectl wait --for=condition=ready pod -l app=ci-cd-agent -n production --timeout=300s
        curl -f https://ci-cd-agent.example.com/webhooks/health
        
    - name: Notify deployment
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        text: 'CI-CD Agent successfully deployed to production! üöÄ'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
  argocd-sync:
    name: Update GitOps and Sync ArgoCD
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITOPS_TOKEN || secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Update image tags in GitOps
      run: |
        # Update with actual commit SHA for production
        IMAGE_TAG="${{ github.sha }}"
        
        # Update base application image tag
        sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|" \
          gitops/applications/ci-cd-agent/kustomization.yaml
          
        # Update staging environment  
        sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|" \
          gitops/environments/staging/kustomization.yaml
          
        # Update production environment (only on main branch)
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|" \
            gitops/environments/production/kustomization.yaml
        fi
        
        echo "üìù GitOps Configuration Updated:"
        echo "   Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        echo "   Base Image Tag: ${IMAGE_TAG}" 
        echo "   Staging Image Tag: ${IMAGE_TAG}"
        echo "   Production Image Tag: ${IMAGE_TAG}"
          
    - name: Commit and push GitOps changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Add all changes
        git add gitops/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "üöÄ GitOps: Update ci-cd-agent image to ${{ github.sha }}
          
          - Updated base image tag: ${{ github.sha }}
          - Updated staging tag: ${{ github.sha }}
          - Updated production tag: ${{ github.sha }}
          - Environment: ${{ github.ref_name }}
          - Workflow: ${{ github.workflow }}
          - Run: ${{ github.run_id }}"
          
          # Try to push, handle permission errors gracefully
          if git push; then
            echo "‚úÖ GitOps repository updated successfully"
          else
            echo "‚ö†Ô∏è  Failed to push GitOps changes - this is expected without GITOPS_TOKEN"
            echo "üí° To enable automatic GitOps updates:"
            echo "   1. Create a Personal Access Token with 'repo' scope"
            echo "   2. Add it as GITOPS_TOKEN secret in repository settings"
            echo "   3. Re-run the workflow"
            echo ""
            echo "üîÑ For now, you can manually apply the GitOps changes:"
            echo "   git pull origin main"
            echo "   kubectl apply -k gitops/applications/ci-cd-agent"
            exit 0  # Don't fail the workflow
          fi
        fi
        
    - name: Prepare ArgoCD Application
      run: |
        echo "üìã ArgoCD Application manifest ready for deployment"
        echo "üè† For local deployment, run:"
        echo "   kubectl apply -f gitops/argocd-application.yaml"
        echo "üîÑ ArgoCD will automatically sync from GitOps repository"
        
    - name: Trigger ArgoCD sync (if configured)
      continue-on-error: true
      run: |
        # Try to sync with ArgoCD API if credentials are available
        if [ -n "${{ secrets.ARGOCD_SERVER }}" ] && [ -n "${{ secrets.ARGOCD_TOKEN }}" ]; then
          echo "üîÑ Triggering ArgoCD sync via API..."
          
          curl -k -X POST "${{ secrets.ARGOCD_SERVER }}/api/v1/applications/ci-cd-agent/sync" \
            -H "Authorization: Bearer ${{ secrets.ARGOCD_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "prune": true,
              "dryRun": false,
              "strategy": {
                "hook": {
                  "force": true
                }
              }
            }' || echo "‚ö†Ô∏è  ArgoCD API sync failed, but GitOps commit will trigger auto-sync"
            
        else
          echo "üí° ArgoCD API credentials not configured"
          echo "üîÑ ArgoCD will auto-sync from GitOps repository changes"
        fi
        
    - name: Local deployment instructions
      run: |
        echo "üéØ Local Deployment Instructions:"
        echo ""
        echo "üìã 1. Apply GitOps changes locally:"
        echo "   ./manual-gitops-sync.sh --update-image"
        echo ""
        echo "üåê 2. Access ArgoCD UI:"
        echo "   kubectl port-forward svc/argocd-server -n argocd 8080:443"
        echo "   URL: https://localhost:8080"
        echo "   Username: admin"
        echo "   Password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
        echo ""
        echo "üìä 3. Check application status:"
        echo "   kubectl get applications -n argocd"
        echo "   kubectl get all -n ci-cd-agent"
        echo ""
        echo "üí° Note: GitHub Actions runs in the cloud and cannot access your local Kind cluster."
        echo "    Use the manual-gitops-sync.sh script to deploy changes locally."
        
  local-deployment:
    name: Deploy to Local/Development
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Pull Docker image from GHCR
      run: |
        echo "üì¶ Pulling image from GHCR..."
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        # Tag it as latest for local use
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ci-cd-agent:latest
        
        echo "‚úÖ Docker image pulled and tagged successfully"
        docker images ci-cd-agent:latest
        
    - name: Save image for local use (optional)
      run: |
        echo "üíæ Saving Docker image to tar file for local transfer..."
        docker save ci-cd-agent:latest > /tmp/ci-cd-agent.tar
        echo "‚úÖ Image saved to /tmp/ci-cd-agent.tar"
        ls -lh /tmp/ci-cd-agent.tar
        
    - name: Deployment summary
      run: |
        echo "üöÄ CI/CD Agent deployment summary:"
        echo ""
        echo "üì¶ Docker image information:"
        echo "   - Registry: ${{ env.REGISTRY }}"
        echo "   - Image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "   - Local tag: ci-cd-agent:latest"
        echo ""
        echo "üîß Ready for local deployment with:"
        echo "   docker run -p 3000:3000 ci-cd-agent:latest"
        echo ""
        echo "üè† For local Kind cluster deployment:"
        echo "   1. Load image into Kind:"
        echo "      kind load docker-image ci-cd-agent:latest --name devops-cluster"
        echo ""
        echo "   2. Apply Kubernetes manifests:"
        echo "      kubectl apply -k gitops/applications/ci-cd-agent"
        echo ""
        echo "   3. Or use manual GitOps sync:"
        echo "      ./manual-gitops-sync.sh --update-image"
        echo ""
        echo "üéØ For ArgoCD deployment:"
        echo "   1. Configure GITOPS_TOKEN secret for GitOps repository access"
        echo "   2. Configure ARGOCD_SERVER and ARGOCD_TOKEN secrets"
        echo "   3. ArgoCD will auto-sync from GitOps repository changes"

  deployment-status:
    name: Deployment Status
    runs-on: ubuntu-latest
    if: always()
    needs: [deploy-staging, deploy-production, argocd-sync, local-deployment]
    
    steps:
    - name: Report deployment status
      run: |
        echo "üéØ CD Pipeline Execution Summary:"
        echo ""
        
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "‚úÖ Staging Deployment: SUCCESS"
        elif [ "${{ needs.deploy-staging.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è  Staging Deployment: SKIPPED (KUBECONFIG_STAGING not configured)"
        else
          echo "‚ùå Staging Deployment: ${{ needs.deploy-staging.result }}"
        fi
        
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "‚úÖ Production Deployment: SUCCESS"
        elif [ "${{ needs.deploy-production.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è  Production Deployment: SKIPPED (KUBECONFIG_PRODUCTION not configured)"
        else
          echo "‚ùå Production Deployment: ${{ needs.deploy-production.result }}"
        fi
        
        if [ "${{ needs.argocd-sync.result }}" == "success" ]; then
          echo "‚úÖ GitOps Sync: SUCCESS"
        elif [ "${{ needs.argocd-sync.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è  GitOps Sync: SKIPPED"
        else
          echo "‚ùå GitOps Sync: ${{ needs.argocd-sync.result }}"
        fi
        
        if [ "${{ needs.local-deployment.result }}" == "success" ]; then
          echo "‚úÖ Local Deployment: SUCCESS"
        elif [ "${{ needs.local-deployment.result }}" == "skipped" ]; then
          echo "‚è≠Ô∏è  Local Deployment: SKIPPED"
        else
          echo "‚ùå Local Deployment: ${{ needs.local-deployment.result }}"
        fi
        
        echo ""
        echo "üí° For local Kind cluster deployment:"
        echo "   1. Pull latest changes: git pull origin main"
        echo "   2. Pull image from GHCR: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "   3. Load into Kind: kind load docker-image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --name devops-cluster"
        echo "   4. Apply GitOps: ./manual-gitops-sync.sh --update-image"
        echo "   5. Access ArgoCD: https://localhost:30080 (admin/LIYGSScjppIVxXd6)"